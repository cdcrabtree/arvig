#' Extract coordinates and address from a geocode locations list.
#'
#' \code{extract_from_geocode} extracts the exact address and coordinates from a list
#'    of locations generated with \code{\link[ggmap]{geocode}}.
#'
#' @param x list of geocoded locations generated by
#'    \code{ggmap::geocode(locations, output = "all", source = "google", nameType = "long")}
#' @return A data frame consisting of \code{address}, \code{lat} and \code{lon} of all locations.
#' @examples
#' \dontrun{
#' extract_from_geocode(ggmap::geocode(c("Paris, France", "London, UK", "Berlin, Germany"),
#' output = "all", source = "google", nameType = "long"))
#' }

extract_from_geocode <- function(x){
  lat <- x$results[[1]]$geometry$location$lat
  lon <- x$results[[1]]$geometry$location$lng
  address <- x$results[[1]]$formatted_address
  result <- dplyr::data_frame(location = address, lat = lat, lon = lon)
  return(result)
}



#' Scrape Events of Right-Wing Violence in 2015 from Online Source.
#'
#' This function is built only for one specific purpose:
#' Scraping the website \url{https://www.mut-gegen-rechte-gewalt.de/service/chronik-vorfaelle}
#' for all events in 2015. It retrieves the date, location, bundesland, category, summary and source
#' for each event and returns a data frame.
#'
#' @param page integer between 0 and n (which is the current maximum number of subpages in the list of events minus 1).
#' @return A data frame of events as listed on the website, consisting of columns for date, location, bundesland,
#'    category, summary and source.
read_data <- function(page) {
  gewalt <- read_html(paste0("https://mut-gegen-rechte-gewalt.de/service/chronik-vorfaelle?&&field_date_value[value][year]=2015&page=", page))

  ort <- gewalt %>%
    html_nodes(".field-name-field-city") %>%
    html_text()

  bundesland <- gewalt %>%
    html_nodes(".field-name-field-bundesland") %>%
    html_text()

  quelle <- gewalt %>%
    html_nodes(".field-name-field-source .field-item") %>%
    html_text()

  datum <- gewalt %>%
    html_nodes(".field-name-field-date") %>%
    html_text()

  kategorie <- gewalt %>%
    html_nodes(".field-name-field-art") %>%
    html_text()

  zusammenfassung <- gewalt %>%
    html_nodes(".field-type-text-with-summary") %>%
    html_text()

  result <- dplyr::data_frame(datum, ort, bundesland, kategorie, zusammenfassung, quelle)
  return(result)
}

#' Find the polygon in which a spatial point is located.
#'
#' Given a spatial polygon data frame and a data frame of point coordinates,
#' this function finds the subregion each point is located in, assigns its
#' respective ID and returns a data frame
#'
#' @param polygon_df polygon data frame in which the spatial points are supposed to be located.
#' @param points_df  data frame of points, consisting at least of a pair of lat/lon variables
#'    as well as a unique ID column.
#' @param key character string naming the column of the spatial polygon data frame which uniquely identifies
#'    each subregion.
#' @param .progress name of the progress bar (from plyr) to use.
#'
#' @return A data frame of unique point IDs and the respective ID for the subregion they are located in.
check_polygons <- function(polygon_df, points_df, key, .progress = "text") {
  num_districts <- unique(as.character(polygon_df@data[[key]])) # only works with map data from Geodatenzentrum
  result <- plyr::ddply(points_df, c("id"), function(point){
    p <- sp::SpatialPoints(point[ , c("lon", "lat")], proj4string=CRS(proj4string(polygon_df)))
    x <- try(polygon_df[p,], silent=TRUE)
    loc <- ifelse(inherits(x, "try-error"), NA, as.character(x@data[[key]]))
    return(data_frame(key = loc))
  }, .progress = .progress)
  return(result)
}
